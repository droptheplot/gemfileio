(function() {
  'use strict';

  angular
    .module('gemfileio')
    .controller('projectsIndexController', projectsIndexController);

  projectsIndexController.$inject = ['$scope', 'projectsFactory', 'categoriesFactory', '$routeParams', 'ngDialog'];

  function projectsIndexController($scope, projectsFactory, categoriesFactory, $routeParams, ngDialog) {
    $scope.projects = [];
    $scope.page = 1;
    $scope.isNextPage = true;

    $scope.loadProjects = function() {
      projectsFactory.query({
        page: $scope.page,
        category_id: $routeParams.category_id,
        query: $routeParams.query,
        active: $routeParams.active || true
      }, function(data, headers) {
        $scope.projects = $scope.projects.concat(data);
        $scope.page += 1;

        $scope.isNextPage = (headers().link === 'true');
      });
    };

    $scope.openProject = function(projectId) {
      ngDialog.open({
        template: "<%= asset_path('templates/projects/show.html') %>",
        controller: 'projectsShowController',
        data: { projectId: projectId }
      })
    };

    if($routeParams.category_id) {
      categoriesFactory.get({ id: $routeParams.category_id }, function(data) {
        $scope.category = data;
      });
    }

    $scope.loadProjects();
  }
})();
