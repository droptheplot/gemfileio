(function() {
  'use strict';

  angular
    .module('gemfileio', ['satellizer', 'templates', 'ngRoute', 'ngResource', 'angular-loading-bar', 'ngDialog', 'angularMoment', 'chart.js']);

  angular
    .module('gemfileio')
    .config(config);

  config.$inject = ['$routeProvider', '$locationProvider', '$authProvider', 'ngDialogProvider'];

  function config($routeProvider, $locationProvider, $authProvider, ngDialogProvider) {
    $routeProvider
      .when('/', {
        controller: 'projectsIndexController',
        templateUrl: "<%= asset_path('templates/projects/index.html') %>"
      })
      .when('/categories/:category_id', {
        controller: 'projectsIndexController',
        templateUrl: "<%= asset_path('templates/projects/index.html') %>"
      })
      .when('/projects/:project_id/edit', {
        controller: 'projectsEditController',
        templateUrl: "<%= asset_path('templates/projects/edit.html') %>",
        security: true
      })
      .when('/projects/new', {
        controller: 'projectsNewController',
        templateUrl: "<%= asset_path('templates/projects/edit.html') %>",
        security: true
      })
      .when('/projects/suggest', {
        controller: 'projectsNewController',
        templateUrl: "<%= asset_path('templates/projects/suggest.html') %>"
      });

    $locationProvider.html5Mode(true);

    ngDialogProvider.setDefaults({
      closeByDocument: true,
      closeByEscape: true,
      showClose: false,
      disableAnimation: true
    });

    $authProvider.signupUrl = '/api/v1/users/signup';
    $authProvider.loginUrl = '/api/v1/users/login';

    $authProvider.github({
      clientId: '<%= Rails.application.secrets.github_client_id %>',
      url: '<%= Rails.application.secrets.github_auth_url %>'
    });
  };

  angular
    .module('gemfileio')
    .run(authSecurity);

  authSecurity.$inject = ['$rootScope', '$location', '$auth']

  function authSecurity($rootScope, $location, $auth) {
    $rootScope.$on('$routeChangeStart', function(event, next) {
      if(next.security && (!$auth.isAuthenticated() || !$auth.getPayload().user.admin)) {
        event.preventDefault();
        $location.path('/');
      }
    });
  };
})()
